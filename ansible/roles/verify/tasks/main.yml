---
- name: Verify Kubernetes cluster health
  become: yes
  block:
    - name: Check API responsiveness
      command: kubectl get --raw='/healthz' --kubeconfig /etc/kubernetes/admin.conf
      register: healthz
      changed_when: false
      failed_when: "'ok' not in healthz.stdout"

    - name: Check node status
      command: kubectl get nodes --no-headers --kubeconfig /etc/kubernetes/admin.conf
      register: nodes
      changed_when: false
      failed_when: "'NotReady' in nodes.stdout"

    - name: Check kube-system pods
      command: kubectl get pods -n kube-system --no-headers --kubeconfig /etc/kubernetes/admin.conf
      register: pods
      changed_when: false
      failed_when: "'CrashLoopBackOff' in pods.stdout"

    - name: Report summary
      debug:
        msg:
          - "Cluster health: OK"
          - "Nodes:"
          - "{{ nodes.stdout_lines }}"
          - "Pods:"
          - "{{ pods.stdout_lines }}"
