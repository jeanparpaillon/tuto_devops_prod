---
- name: Disable swap
  command: swapoff -a
  when: ansible_swaptotal_mb > 0
  become: true

- name: Remove swap entries
  replace:
    path: /etc/fstab
    regexp: '^\s*([^#]\S*\s+\S+\s+swap\s+)'
    replace: '# \1'
  become: true

- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  become: true

- name: Enable kernel modules
  copy:
    dest: /etc/modules-load.d/containerd.conf
    content: |
      overlay
      br_netfilter
  become: true

- name: Load br_netfilter kernel module
  # Ensure br_netfilter is loaded now so /proc/sys/net/bridge/* entries exist
  # (we also keep the module in /etc/modules-load.d for persistence)
  ansible.builtin.command: modprobe br_netfilter
  become: true

- name: Enable bridge-nf-call
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - { name: net.bridge.bridge-nf-call-iptables, value: 1 }
    - { name: net.ipv4.ip_forward, value: 1 }
  become: true

- name: Install containerd
  ansible.builtin.apt:
    name: containerd
    state: present
  become: true

- name: Configure containerd
  ansible.builtin.shell: |
    containerd config default > /etc/containerd/config.toml
    sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
    systemctl restart containerd
  become: true

- name: Install kubeadm, kubelet, kubectl
  ansible.builtin.shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key \
      | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
      https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /" \
      > /etc/apt/sources.list.d/kubernetes.list
    apt update
    apt install -y kubelet kubeadm kubectl
    apt-mark hold kubelet kubeadm kubectl
  become: true
